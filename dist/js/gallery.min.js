!function(e){"use strict";function t(){this.LAYOUT={PUZZLE:1,WATERFALL:2,BARREL:3},this.version="1.0.0"}function n(e,t,n){e.addEventListener?e.addEventListener(t,n):e.attachEvent?e.attachEvent("on"+t,n):e["on"+t]=n}function i(e,t){return"string"!=typeof t?void console.error("removeClass: type of name is not string"):void(null===e||"string"!=typeof t||e.className.match(t)||(t=t.trim(),e.className+=" "+t,e.className=e.className.trim()))}function o(e,t){return"string"!=typeof t?void console.error("removeClass: type of name is not string"):(t=t.trim(),null!==e?e.className.match(t):void 0)}function r(e,t){if("string"!=typeof t)return void console.error("removeClass: type of name is not string");t=t.trim();var n=new RegExp(" ?\\b"+t+"\\b","g");null!==e&&e.className.match(t)&&(e.className=e.className.replace(n,""))}function l(e){e.stopPropagation?e.stopPropagation():e.cancelBubble=!0}function a(){N(),C.style.width=I.conWidth+"px",C.style.height=I.conHeight+"px",L=C.clientWidth,z=-1,c()}function s(){var e,t,n=C.querySelectorAll(".puzzle-item"),i=I.conWidth,o=I.conHeight;switch(n.length){case 3:n[0].style.width=i-o/2+"px",n[0].style.height=o+"px",n[1].style.width=o/2+"px",n[1].style.height=o/2+"px",n[2].style.width=o/2+"px",n[2].style.height=o/2+"px";break;case 5:n[4].style.width=i/3+"px",n[4].style.height=o-i/3+"px";break;default:for(e=n.length,t=0;t<e;t++)n[t].style.width="",n[t].style.height=""}}function c(){var e=b.length,t=C.className.match(/puzzle-\d/);if(e){e>6&&(e=6),t&&(t=t[0]),r(C,t),i(C,"puzzle-"+e);for(var n="";++z<e;)n=b[z].src,C.innerHTML+='<div imgIndex="'+z+'" class="puzzle-item" style="background-image: url('+n+');"><div imgIndex="'+z+'"class="img-delete">delete</div></div>';z--,s()}}function m(){N(),k=[],L=C.clientWidth,i(C,"waterfall");var e,t=T.colCnt,n="",o="";for(M=(L-A[0]*(t-1))/t,e=0;e<t;e++)o="",o+="width:"+M+"px;",o+="margin-right:"+A[0]+"px;",n+='<div class="waterfall-col" style="'+o+'"></div>';C.innerHTML+=n,C.style.width=L+"px",k=C.getElementsByClassName("waterfall-col"),z=-1,h()}function d(){var e,t,n=k.length,i=Number.MAX_VALUE,o=-1;for(e=0;e<n;e++)t=k[e].clientHeight,t<i&&(o=e,i=t);return k[o]}function h(){for(var e,t,n,i,o,r,l,a=b.length;++z<a;)e=b[z],t=e.originalWidth,n=e.originalHeight,i=M,o=i*n/t,r='<div class="waterfall-item" style="margin-bottom:'+A[1]+'px"><img imgIndex="'+z+'" src="'+e.src+'"width="'+i+'" height="'+o+'" /><div imgIndex="'+z+'"class="img-delete">delete</div></div>',l=d(),l.innerHTML+=r;z--}function u(){N(),i(C,"barrel"),L=C.clientWidth,C.style.width=Math.ceil(L)+"px",U=document.createElement("div"),U.style.marginBottom=A[1]+"px",i(U,"barrel-row"),C.appendChild(U),O=0,R=[],z=-1,g()}function g(){for(var e,t,n,i,o,r,l,a,s,c=b.length;++z<c;)e=b[z],t=e.width,n=e.height,i=t/n,o=W.maxHeight,r='<div class="barrel-item" style="margin-right: '+A[0]+'px"><img imgIndex="'+z+'" width="'+o*i+'" height="'+o+'" src="'+e.src+'"/><div imgIndex="'+z+'" class="img-delete">delete</div></div>',l=U.children.length,a=W.minCnt,s=W.maxCnt,l<a||l>=a&&l<s&&O>o?(U.innerHTML+=r,p(i),f()):(U=document.createElement("div"),U.className="barrel-row",U.innerHTML+=r,U.style.marginBottom=A[1]+"px",C.appendChild(U),R=[],p(i),f());z--}function p(e){R.push(e);for(var t=0,n=R.length,i=0;i<n;i++)t+=R[i];O=(L-(n-1)*A[0])/t}function f(){var e,t=U.querySelectorAll(".barrel-item"),n=U.querySelectorAll(".barrel-item img"),i=t.length,o=0,r=!1,l=0,a=0;for(e=0;e<i;e++)a+=W.maxHeight*R[e];for(i<W.minCnt&&a<L||O>W.maxHeight?o=W.maxHeight:(o=O,r=!0),e=0;e<i;e++)n[e].width=o*R[e],n[e].height=o;if(r){for(e=0;e<i;e++)l+=n[e].width;n[i-1].width+=L-(i-1)*A[0]-l}}function y(){var e=document.documentElement.clientHeight,t=(document.documentElement.clientWidth,document.createElement("div"));t.id="modal",t.className="modal",t.style.height=e+"px",t.innerHTML='<div class="modal-mask"></div><img class="modal-img" /><button class="prev"></button><button class="next"></button>',document.body.appendChild(t)}function v(){function t(e){var t=b[e],n=t.originalWidth,i=t.originalHeight,o=document.documentElement.clientWidth,r=document.documentElement.clientHeight,l=n/i;n>o&&i>r?l>o/r?(n=o,i=o/l):(n=r*l,i=r):n>o&&i<r?(n=o,i=o/l):n<o&&i>r&&(n=r*l,i=r),s.src=t.src,s.index=e,s.style.width=n+"px",s.style.height=i+"px",s.style.marginLeft=-n/2+"px",s.style.marginTop=-i/2+"px"}y();var a=document.getElementById("modal"),s=a.getElementsByClassName("modal-img")[0],c=(a.getElementsByClassName("modal-mask")[0],a.getElementsByClassName("prev")[0]),m=a.getElementsByClassName("next")[0];n(C,"click",function(n){n=n||e.event;var r=n.target||n.srcElement;if(B&&(o(r,"puzzle-item")||"img"===r.nodeName.toLowerCase())){var l=r.getAttribute("imgIndex");t(l),i(a,"show")}}),n(a,"click",function(){r(a,"show")}),n(e,"resize",function(){a.style.height=document.documentElement.clientHeight+"px"}),n(c,"click",function(n){n=n||e.event;var i=s.index;t(i?--i:z),l(n)}),n(m,"click",function(n){n=n||e.event;var i=s.index;t(i<z?++i:0),l(n)})}function x(e){var t=H;e=e.toUpperCase(),E[e][t]()}function N(){for(var e=w.length,t=0;t<e;t++)r(C,w[t]);C.style.cssText="",C.innerHTML=""}var w=["puzzle-1","puzzle-2","puzzle-3","puzzle-4","puzzle-5","puzzle-6","waterfall","barrel"],E={ADD:{1:function(){c()},2:function(){h()},3:function(){g()}},RESET:{1:function(){a()},2:function(){m()},3:function(){u()}}},C=document.getElementById("mygallery"),H=1,L=0,b=[],z=-1,B=!0,A=[10,10],I={conWidth:C.clientWidth,conHeight:C.clientWidth/2},T={colCnt:4},W={minHeight:200,maxHeight:300,maxCnt:6,minCnt:3},k=[],M=0,U=null,R=[],O=0;String.prototype.trim=String.prototype.trim||function(){return this.replace(/(^\s*)|(\s*$)/g,"")},t.prototype.setImage=function(e,t){return"string"==typeof e?void this.setImage([e]):(e=e||[],t=t||{},v(),b=[],t.layout&&this.setLayout(t.layout),t.gutter&&this.setGutter(t.gutter),isNaN(t.conWidth)||(I.conWidth=t.conWidth),isNaN(t.conHeight)||(I.conHeight=t.conHeight),isNaN(t.colCnt)||(T.colCnt=t.colCnt),t.minCnt&&t.maxCnt&&this.setBarrelBin(t.minCnt,t.maxCnt),t.minHeight&&t.maxHeight&&this.setBarrelHeight(t.minHeight,t.maxHeight),x("reset"),void this.addImage(e))},t.prototype.getImageDomElements=function(){var e="";switch(this.getLayout()){case this.LAYOUT.PUZZLE:e="puzzle-item";break;case this.LAYOUT.WATERFALL:e="waterfall-item";break;case this.LAYOUT.BARREL:e="barrel-item"}return C.getElementsByClassName(e)},t.prototype.addImage=function(e,t){function n(){this.originalWidth=this.width,this.originalHeight=this.height,b.push(this),x("add"),"function"==typeof t&&t(this)}function i(){console.error("fail to load the image "+this.src),"function"==typeof t&&t(this)}if("string"==typeof e)return void this.addImage([e],t);var o,r,l=e.length;for(o=0;o<l;o++)r=new Image,r.src=e[o],r.onload=n,r.onerror=i},t.prototype.removeImage=function(e){b[e]&&b.splice(e,1),x("reset")},t.prototype.setLayout=function(e){if(isNaN(e))return void console.error("setLayout: wrong param type");if(e!==H)switch(e){case this.LAYOUT.PUZZLE:case this.LAYOUT.WATERFALL:case this.LAYOUT.BARREL:H=e,x("reset");break;default:console.error("no such layout")}},t.prototype.getLayout=function(){return H},t.prototype.setGutter=function(e,t){return isNaN(e)||e<0||isNaN(t)&&"undefined"!=typeof t?void console.error("图片间距设定参数错误"):("undefined"==typeof t&&(t=e),A[0]=e,A[1]=t,void x("reset"))},t.prototype.setColcnt=function(e){return isNaN(e)||e<0?void console.error("列数输入错误"):(T.colCnt=e,void x("reset"))},t.prototype.enableFullscreen=function(){B=!0},t.prototype.disableFullscreen=function(){B=!1},t.prototype.isFullscreenEnabled=function(){return B},t.prototype.setBarrelBin=function(e,t){return isNaN(e)||isNaN(t)||e<=0||t<=0?void console.error("木桶布局单行图片数上下限设定错误"):parseInt(e)!=e||parseInt(t)!=t?void console.error("木桶布局上下限不能为浮点数"):e>t?void console.error("木桶图片数上限不能低于木桶图片数下限"):(W.maxCnt=t,W.minCnt=e,void x("reset"))},t.prototype.getBarrelBinMax=function(){return W.maxCnt},t.prototype.getBarrelBinMin=function(){return W.minCnt},t.prototype.setBarrelHeight=function(e,t){return isNaN(e)||isNaN(t)||t<0||e<0?void console.error("木桶模式高度上下限设定参数要为正实数"):t<e?void console.error("木桶模式高度上限不能低于下限"):(W.maxHeight=t,W.minHeight=e,void x("reset"))},t.prototype.getBarrelHeightMax=function(){return W.maxCnt},t.prototype.getBarrelHeightMin=function(){return W.minCnt},"undefined"==typeof e.gallery&&(e.gallery=new t),n(C,"click",function(t){t=t||e.event;var n=t.target||t.srcElement,i=-1;o(n,"img-delete")&&(i=n.getAttribute("imgIndex"),gallery.removeImage(i))}),n(e,"resize",function(){x("reset")})}(window);