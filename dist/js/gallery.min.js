!function(e){"use strict";function t(){this.LAYOUT={PUZZLE:1,WATERFALL:2,BARREL:3},this.version="1.0.0"}function i(e,t,i){e.addEventListener?e.addEventListener(t,i):e.attachEvent?e.attachEvent("on"+t,i):e["on"+t]=i}function n(e,t){return"string"!=typeof t?void console.error("removeClass: type of name is not string"):void(null===e||"string"!=typeof t||e.className.match(t)||(t=t.trim(),e.className+=" "+t,e.className=e.className.trim()))}function r(e,t){return"string"!=typeof t?void console.error("removeClass: type of name is not string"):(t=t.trim(),null!==e?e.className.match(t):void 0)}function o(e,t){if("string"!=typeof t)return void console.error("removeClass: type of name is not string");t=t.trim();var i=new RegExp(" ?\\b"+t+"\\b","g");null!==e&&e.className.match(t)&&(e.className=e.className.replace(i,""))}function l(e){e.stopPropagation?e.stopPropagation():e.cancelBubble=!0}function a(){N(),L=E.clientWidth,I.conWidth=E.clientWidth,I.conHeight=E.clientHeight||E.clientWidth/2,E.style.width=E.clientWidth+"px",E.style.height=I.conHeight+"px",z=-1,c()}function s(){var e,t,i=E.querySelectorAll(".puzzle-item"),n=I.conWidth,r=I.conHeight;switch(i.length){case 3:i[0].style.width=n-r/2+"px",i[0].style.height=r+"px",i[1].style.width=r/2+"px",i[1].style.height=r/2+"px",i[2].style.width=r/2+"px",i[2].style.height=r/2+"px";break;case 5:i[4].style.width=n/3+"px",i[4].style.height=r-n/3+"px";break;default:for(e=i.length,t=0;t<e;t++)i[t].style.width="",i[t].style.height=""}}function c(){var e=b.length,t=E.className.match(/puzzle-\d/);if(e){e>6&&(e=6),t&&(t=t[0]),o(E,t),n(E,"puzzle-"+e);for(var i="";++z<e;)i=b[z].src,E.innerHTML+='<div imgIndex="'+z+'" class="puzzle-item" style="background-image: url('+i+');"><div imgIndex="'+z+'"class="img-delete">delete</div></div>';z--,s()}}function m(){N(),k=[],L=E.clientWidth,n(E,"waterfall");var e,t=T.colCnt,i="",r="";for(M=(L-A[0]*(t-1))/t,e=0;e<t;e++)r="",r+="width:"+M+"px;",r+="margin-right:"+A[0]+"px;",i+='<div class="waterfall-col" style="'+r+'"></div>';E.innerHTML+=i,E.style.width=L+"px",k=E.getElementsByClassName("waterfall-col"),z=-1,h()}function d(){var e,t,i=k.length,n=Number.MAX_VALUE,r=-1;for(e=0;e<i;e++)t=k[e].clientHeight,t<n&&(r=e,n=t);return k[r]}function h(){for(var e,t,i,n,r,o,l,a=b.length;++z<a;)e=b[z],t=e.originalWidth,i=e.originalHeight,n=M,r=n*i/t,o='<div class="waterfall-item" style="margin-bottom:'+A[1]+'px"><img imgIndex="'+z+'" src="'+e.src+'"width="'+n+'" height="'+r+'" /><div imgIndex="'+z+'"class="img-delete">delete</div></div>',l=d(),l.innerHTML+=o;z--}function g(){N(),n(E,"barrel"),L=E.clientWidth,E.style.width=Math.ceil(L)+"px",U=document.createElement("div"),U.style.marginBottom=A[1]+"px",n(U,"barrel-row"),E.appendChild(U),O=0,R=[],z=-1,u()}function u(){for(var e,t,i,n,r,o,l,a,s,c=b.length;++z<c;)e=b[z],t=e.width,i=e.height,n=t/i,r=W.maxHeight,o='<div class="barrel-item" style="margin-right: '+A[0]+'px"><img imgIndex="'+z+'" width="'+r*n+'" height="'+r+'" src="'+e.src+'"/><div imgIndex="'+z+'" class="img-delete">delete</div></div>',l=U.children.length,a=W.minCnt,s=W.maxCnt,l<a||l>=a&&l<s&&O>r?(U.innerHTML+=o,p(n),f()):(U=document.createElement("div"),U.className="barrel-row",U.innerHTML+=o,U.style.marginBottom=A[1]+"px",E.appendChild(U),R=[],p(n),f());z--}function p(e){R.push(e);for(var t=0,i=R.length,n=0;n<i;n++)t+=R[n];O=(L-(i-1)*A[0])/t}function f(){var e,t=U.querySelectorAll(".barrel-item"),i=U.querySelectorAll(".barrel-item img"),n=t.length,r=0,o=!1,l=0,a=0;for(e=0;e<n;e++)a+=W.maxHeight*R[e];for(n<W.minCnt&&a<L||O>W.maxHeight?r=W.maxHeight:(r=O,o=!0),e=0;e<n;e++)i[e].width=r*R[e],i[e].height=r;if(o){for(e=0;e<n;e++)l+=i[e].width;i[n-1].width+=L-(n-1)*A[0]-l}}function y(){var e=document.documentElement.clientHeight,t=(document.documentElement.clientWidth,document.createElement("div"));t.id="modal",t.className="modal",t.style.height=e+"px",t.innerHTML='<div class="modal-mask"></div><img class="modal-img" /><button class="prev"></button><button class="next"></button>',document.body.appendChild(t)}function v(){function t(e){var t=b[e],i=t.originalWidth,n=t.originalHeight,r=document.documentElement.clientWidth,o=document.documentElement.clientHeight,l=i/n;i>r&&n>o?l>r/o?(i=r,n=r/l):(i=o*l,n=o):i>r&&n<o?(i=r,n=r/l):i<r&&n>o&&(i=o*l,n=o),s.src=t.src,s.index=e,s.style.width=i+"px",s.style.height=n+"px",s.style.marginLeft=-i/2+"px",s.style.marginTop=-n/2+"px"}y();var a=document.getElementById("modal"),s=a.getElementsByClassName("modal-img")[0],c=(a.getElementsByClassName("modal-mask")[0],a.getElementsByClassName("prev")[0]),m=a.getElementsByClassName("next")[0];i(E,"click",function(i){i=i||e.event;var o=i.target||i.srcElement;if(B&&(r(o,"puzzle-item")||"img"===o.nodeName.toLowerCase())){var l=o.getAttribute("imgIndex");t(l),n(a,"show")}}),i(a,"click",function(){o(a,"show")}),i(e,"resize",function(){a.style.height=document.documentElement.clientHeight+"px"}),i(c,"click",function(i){i=i||e.event;var n=s.index;t(n?--n:z),l(i)}),i(m,"click",function(i){i=i||e.event;var n=s.index;t(n<z?++n:0),l(i)})}function x(e){var t=C;e=e.toUpperCase(),w[e][t]()}function N(){for(var e=H.length,t=0;t<e;t++)o(E,H[t]);E.style.cssText="",E.innerHTML=""}var H=["puzzle-1","puzzle-2","puzzle-3","puzzle-4","puzzle-5","puzzle-6","waterfall","barrel"],w={ADD:{1:c,2:h,3:u},RESET:{1:a,2:m,3:g}},E=document.getElementById("mygallery"),C=1,L=0,b=[],z=-1,B=!0,A=[10,10],I={conWidth:0,conHeight:0},T={colCnt:4},W={minHeight:200,maxHeight:300,maxCnt:6,minCnt:3},k=[],M=0,U=null,R=[],O=0;String.prototype.trim=String.prototype.trim||function(){return this.replace(/(^\s*)|(\s*$)/g,"")},t.prototype.setImage=function(e,t){return"string"==typeof e?void this.setImage([e]):(e=e||[],t=t||{},v(),b=[],t.layout&&this.setLayout(t.layout),t.gutter&&this.setGutter(t.gutter.x,t.gutter.y),t.fullscreen!==!0&&t.fullscreen!==!1||(B=t.fullscreen),isNaN(t.conWidth)||(I.conWidth=t.conWidth),isNaN(t.conHeight)||(I.conHeight=t.conHeight),isNaN(t.colCnt)||(T.colCnt=t.colCnt),t.minCnt&&t.maxCnt&&this.setBarrelBin(t.minCnt,t.maxCnt),t.minHeight&&t.maxHeight&&this.setBarrelHeight(t.minHeight,t.maxHeight),x("reset"),void this.addImage(e))},t.prototype.getImageDomElements=function(){var e="";switch(this.getLayout()){case this.LAYOUT.PUZZLE:e="puzzle-item";break;case this.LAYOUT.WATERFALL:e="waterfall-item";break;case this.LAYOUT.BARREL:e="barrel-item"}return E.getElementsByClassName(e)},t.prototype.addImage=function(e,t){function i(){this.originalWidth=this.width,this.originalHeight=this.height,b.push(this),x("add"),"function"==typeof t&&t(this)}function n(){console.error("fail to load the image "+this.src),"function"==typeof t&&t(this)}if("string"==typeof e)return void this.addImage([e],t);var r,o,l=e.length;for(r=0;r<l;r++)o=new Image,o.src=e[r],o.onload=i,o.onerror=n},t.prototype.removeImage=function(e){b[e]&&b.splice(e,1),x("reset")},t.prototype.setLayout=function(e){if(isNaN(e))return void console.error("setLayout: wrong param type");if(e!==C)switch(e){case this.LAYOUT.PUZZLE:case this.LAYOUT.WATERFALL:case this.LAYOUT.BARREL:C=e,x("reset");break;default:console.error("no such layout")}},t.prototype.getLayout=function(){return C},t.prototype.setGutter=function(e,t){return isNaN(e)||e<0||isNaN(t)&&"undefined"!=typeof t?void console.error("图片间距设定参数错误"):("undefined"==typeof t&&(t=e),A[0]=e,A[1]=t,void x("reset"))},t.prototype.setColcnt=function(e){return isNaN(e)||e<0?void console.error("列数输入错误"):(T.colCnt=e,void x("reset"))},t.prototype.enableFullscreen=function(){B=!0},t.prototype.disableFullscreen=function(){B=!1},t.prototype.isFullscreenEnabled=function(){return B},t.prototype.setBarrelBin=function(e,t){return isNaN(e)||isNaN(t)||e<=0||t<=0?void console.error("木桶布局单行图片数上下限设定错误"):parseInt(e)!=e||parseInt(t)!=t?void console.error("木桶布局上下限不能为浮点数"):e>t?void console.error("木桶图片数上限不能低于木桶图片数下限"):(W.maxCnt=t,W.minCnt=e,void x("reset"))},t.prototype.getBarrelBinMax=function(){return W.maxCnt},t.prototype.getBarrelBinMin=function(){return W.minCnt},t.prototype.setBarrelHeight=function(e,t){return isNaN(e)||isNaN(t)||t<0||e<0?void console.error("木桶模式高度上下限设定参数要为正实数"):t<e?void console.error("木桶模式高度上限不能低于下限"):(W.maxHeight=t,W.minHeight=e,void x("reset"))},t.prototype.getBarrelHeightMax=function(){return W.maxCnt},t.prototype.getBarrelHeightMin=function(){return W.minCnt},"undefined"==typeof e.gallery&&(e.gallery=new t),i(E,"click",function(t){t=t||e.event;var i=t.target||t.srcElement,n=-1;r(i,"img-delete")&&(n=i.getAttribute("imgIndex"),gallery.removeImage(n))}),i(e,"resize",function(){x("reset")})}(window);